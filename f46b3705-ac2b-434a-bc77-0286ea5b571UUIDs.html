<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Meditate</title>
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<style>
  :root{ --pri:#5B8DEF; --ink:#0F172A; }
  body{font-family:ui-sans-serif,Inter,system-ui,Segoe UI,Roboto,Arial}
  .card{background:#fff;border-radius:1rem;box-shadow:0 8px 24px -16px rgba(15,23,42,.18),0 2px 8px -4px rgba(15,23,42,.08)}
  .btn{border-radius:.9rem;padding:.65rem 1rem;font-weight:600}
  .btn-pri{background:var(--pri);color:#fff}
  .btn-ghost{background:#EEF2FF;color:#1E293B}
  .slider{appearance:none;height:6px;border-radius:9999px;background:#E5E7EB}
  .slider::-webkit-slider-thumb{appearance:none;height:18px;width:18px;border-radius:50%;background:var(--pri)}
  .label{font-size:.75rem;color:#64748B}
  .value{font-size:.75rem;font-family:ui-monospace,Menlo,monospace;color:#334155}
  .badge{font-size:.68rem;padding:.2rem .5rem;border-radius:.5rem;background:#EEF2FF;color:#1E293B;white-space:nowrap}
  .chip{padding:.3rem .6rem;border-radius:9999px;font-size:.75rem;border:1px solid #e2e8f0;cursor:pointer}
  .chip[data-active="1"]{background:#1e293b;color:#fff;border-color:#1e293b}
  .hint{font-size:.72rem;color:#64748B}
</style>
</head>
<body class="bg-gradient-to-b from-slate-50 to-slate-100 min-h-screen p-5 text-slate-900">

<div class="max-w-4xl mx-auto space-y-6">
  <header class="space-y-2">
    <div class="flex items-center gap-3 flex-wrap">
      <h1 class="text-3xl font-bold tracking-tight">Mindfull</h1>
      <span id="guardState" class="badge">Guardrails: ON</span>
      <span id="micState" class="badge">Mic: off</span>
      <span id="snapState" class="badge">Snaps: idle</span>
      <span id="wakeState" class="badge">Awake: off</span>
      <button id="enableMic" class="ml-auto btn btn-pri text-sm">Enable Snap Control</button>
    </div>
    <p class="text-slate-600 text-sm">Safety-tuned isochronic pulses • Finger snap to start/stop • Screen stays awake during sessions.</p>
  </header>

  <!-- Filters -->
  <section class="card p-5">
    <div class="flex items-center gap-2 flex-wrap">
      <span class="label mr-2">Filter:</span>
      <button class="chip" data-chip data-cat="all" data-active="1">All</button>
      <button class="chip" data-chip data-cat="calm">Calm</button>
      <button class="chip" data-chip data-cat="wellness">Wellness</button>
      <button class="chip" data-chip data-cat="sacred">Sacred</button>
      <button class="chip" data-chip data-cat="work">Work/Study</button>
      <button class="chip" data-chip data-cat="social">Social/Rec</button>
      <button class="chip" data-chip data-cat="active">Active/Athletic</button>
    </div>
  </section>

  <!-- Controls -->
  <section class="card p-5 space-y-4">
    <div class="grid md:grid-cols-2 gap-4">
      <!-- Preset & tone -->
      <div class="card p-4">
        <div class="space-y-3">
          <div>
            <label class="label block">Playlist / Mode</label>
            <select id="presetSel" class="w-full mt-1 rounded-xl border border-gray-300 px-3 py-2"></select>
            <div class="mt-2 text-xs text-slate-600" id="presetTags"></div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <label class="inline-flex items-center gap-2 text-sm">
              <input id="autoNormalize" type="checkbox" class="rounded"/> Auto-normalize after session
            </label>
            <button id="panicCalm" class="btn btn-ghost text-sm">Emergency Calm</button>
          </div>

          <div class="flex items-center gap-3">
            <span class="label w-28">Pulse (Hz)</span>
            <input id="pulseHz" type="range" min="0.5" max="40" step="0.1" class="slider w-full"/>
            <span id="pulseHzV" class="value w-14 text-right">10.0</span>
          </div>
          <div class="flex items-center gap-3">
            <span class="label w-28">Carrier (Hz)</span>
            <input id="carrierHz" type="range" min="120" max="500" step="1" value="200" class="slider w-full"/>
            <span id="carrierHzV" class="value w-14 text-right">200</span>
          </div>
          <div class="flex items-center gap-3">
            <span class="label w-28">Pulse Depth</span>
            <input id="depth" type="range" min="0" max="1" step="0.01" value="0.85" class="slider w-full"/>
            <span id="depthV" class="value w-14 text-right">0.85</span>
          </div>
          <div class="flex items-center gap-3">
            <span class="label w-28">Wave Volume</span>
            <input id="waveGain" type="range" min="0" max="1" step="0.01" value="0.35" class="slider w-full"/>
            <span id="waveGainV" class="value w-14 text-right">0.35</span>
          </div>

          <div class="flex items-center gap-3">
            <button id="startWave" class="btn btn-ghost">Start</button>
            <button id="stopWave" class="btn btn-ghost">Stop</button>
            <span id="status" class="ml-auto label">Idle</span>
          </div>
        </div>
      </div>

      <!-- Session & Safety -->
      <div class="card p-4">
        <div class="space-y-3">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="label block">Session Length</label>
              <select id="length" class="w-full mt-1 rounded-xl border border-gray-300 px-3 py-2">
                <option value="10">10 min</option>
                <option value="15">15 min</option>
                <option value="30" selected>30 min</option>
                <option value="60">60 min</option>
                <option value="0">Continuous</option>
              </select>
            </div>
            <div>
              <label class="label block">Timer</label>
              <div id="timer" class="value mt-2">00:00</div>
            </div>
          </div>

          <div class="p-3 rounded-lg bg-slate-50 border border-gray-200">
            <div class="flex items-center gap-2">
              <strong class="text-sm">Safety Advisor</strong>
              <span id="riskBadge" class="badge">Risk: low</span>
              <span id="budgetBadge" class="badge">Stim budget: OK</span>
            </div>
            <ul id="safetyNotes" class="list-disc pl-5 mt-2 text-[12px] text-slate-600 space-y-1"></ul>
          </div>

          <p class="hint">
            Isochronic pulses work on speakers or headphones. These presets are experimental and not medical advice.
            Stop if you feel discomfort. Hydrate, take breaks, and keep volumes moderate.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Recent sessions -->
  <section class="card p-5">
    <div class="flex items-center">
      <h2 class="text-lg font-semibold">Recent Sessions</h2>
      <button id="clearHist" class="ml-auto btn btn-ghost text-sm">Clear</button>
    </div>
    <div id="hist" class="mt-3 text-sm text-slate-700 space-y-1"></div>
  </section>
</div>

<script>
/* ---------------- Presets + Safety metadata ---------------- */
const PRESETS = {
  playlists: [
    /* Calm */
    { id:'mantra',   label:'Mantra / Meditation', cat:'calm',     pulseHz: 2.0,  carrierHz:200,   waveGain:0.40 },
    { id:'creative', label:'Creativity / Dream',  cat:'calm',     pulseHz: 6.0,  carrierHz:210,   waveGain:0.35 },
    { id:'calm',     label:'Calm Focus / Reading',cat:'calm',     pulseHz:10.0,  carrierHz:220,   waveGain:0.30 },

    /* Sacred */
    { id:'om',       label:'Om (ॐ) Cosmic Tone',  cat:'sacred',   pulseHz: 7.83, carrierHz:136.1, waveGain:0.35 },
    { id:'gayatri',  label:'Gayatri Mantra Mode', cat:'sacred',   pulseHz: 7.0,  carrierHz:110.0, waveGain:0.30 },

    /* Wellness */
    { id:'healing',  label:'Healing',             cat:'wellness', pulseHz: 5.5,  carrierHz:528.0, waveGain:0.36 },
    { id:'rejuv',    label:'Rejuvenation',        cat:'wellness', pulseHz: 9.0,  carrierHz:285.0, waveGain:0.34 },

    /* Work/Study */
    { id:'study',    label:'Study / Deep Work',   cat:'work',     pulseHz:15.0,  carrierHz:220,   waveGain:0.30 },
    { id:'learn',    label:'Learning / Memory',   cat:'work',     pulseHz:40.0,  carrierHz:260,   waveGain:0.25 },
    { id:'laser_focus',  label:'Laser Focus',     cat:'work',     pulseHz:16.0,  carrierHz:230,   waveGain:0.30 },
    { id:'pomodoro',     label:'Pomodoro Work',   cat:'work',     pulseHz:13.0,  carrierHz:230,   waveGain:0.30 },

    /* Social/Rec */
    { id:'sensual',  label:'Sensual / Intimate',  cat:'social',   pulseHz: 9.0,  carrierHz:220,   waveGain:0.35 },
    { id:'dance',    label:'Dance / Groove',      cat:'social',   pulseHz:14.0,  carrierHz:240,   waveGain:0.25 },
    { id:'party',    label:'Party / Energy',      cat:'social',   pulseHz:18.0,  carrierHz:250,   waveGain:0.22 },
    { id:'cannabis', label:'Recreational / Cannabis', cat:'social', pulseHz: 8.0, carrierHz:432.0, waveGain:0.38 },

    /* Active/Athletic (new) */
    { id:'focuspeak', label:'Peak Focus (Athletes)',  cat:'active', pulseHz:14.0, carrierHz:240, waveGain:0.28 },
    { id:'stamina',   label:'Endurance / Workers',    cat:'active', pulseHz:16.0, carrierHz:250, waveGain:0.30 },
    { id:'power',     label:'Strength / Power',       cat:'active', pulseHz:18.0, carrierHz:260, waveGain:0.32 },
    { id:'reaction',  label:'Reflex / Gamers',        cat:'active', pulseHz:20.0, carrierHz:270, waveGain:0.30 },
    { id:'hyper',     label:'Hyper-Active Boost',     cat:'active', pulseHz:25.0, carrierHz:280, waveGain:0.30 },

    /* Normalizers / Grounding */
    { id:'normalize_soft', label:'Normalize (soft → ground)', cat:'calm', pulseHz:8.0, carrierHz:220, waveGain:0.22 },
    { id:'ground',         label:'Ground (Schumann ~7.83Hz)', cat:'calm', pulseHz:7.83, carrierHz:136.1, waveGain:0.22 },
    { id:'wake_up',  label:'Wake Up',               cat:'social',   pulseHz:20.0, carrierHz:240, waveGain:0.26 },
    { id:'motivate', label:'Motivation Boost',      cat:'social',   pulseHz:22.0, carrierHz:250, waveGain:0.26 },
    { id:'problem_solve', label:'Problem Solving',  cat:'work',     pulseHz:32.0, carrierHz:260, waveGain:0.24 }
  ],
  isochronic: { depth:0.85, attackMs:10, releaseMs:12 }
};

/* -------- Safety helpers -------- */
function computeSafety(pulse, cat){
  const notes=[];
  let risk='low', maxMinutes=30, minBreakMin=10, maxDepth=0.8, maxWaveGain=0.35;

  if(pulse >= 25){
    risk='high'; maxMinutes=10; minBreakMin=45; maxDepth=0.65; maxWaveGain=0.30;
    notes.push('Very activating band—use short sessions only.');
  }else if(pulse >= 20){
    risk='high'; maxMinutes=15; minBreakMin=30; maxDepth=0.7; maxWaveGain=0.32;
    notes.push('Upper beta/low gamma—keep volume & depth modest.');
  }else if(pulse >= 14){
    risk='medium'; maxMinutes=25; minBreakMin=20; maxDepth=0.75; maxWaveGain=0.34;
    notes.push('Stimulating band—schedule short breaks.');
  }else{
    risk='low'; maxMinutes=45; minBreakMin=10; maxDepth=0.85; maxWaveGain=0.4;
    notes.push('Gentle band—still keep volumes moderate.');
  }
  if(cat==='active'){
    maxMinutes = Math.min(maxMinutes, pulse>=20 ? 15 : 25);
    minBreakMin = Math.max(minBreakMin, pulse>=20 ? 45 : 20);
    maxDepth = Math.min(maxDepth, 0.7);
    maxWaveGain = Math.min(maxWaveGain, 0.32);
    notes.push('Athletic/active mode: stricter guardrails applied.');
  }
  maxDepth = Math.max(0.5, Math.min(0.9, maxDepth));
  maxWaveGain = Math.max(0.18, Math.min(0.45, maxWaveGain));

  return {risk, maxMinutes, minBreakMin, maxDepth, maxWaveGain, notes};
}

/* Daily stim budget (>=14Hz) */
const BUDGET_KEY='vibe_daily_stim_budget_v1';
function readBudget(){ const today = new Date().toISOString().slice(0,10); const raw = JSON.parse(localStorage.getItem(BUDGET_KEY)||'{}'); if(!raw[today]) raw[today]={minutes:0}; return {today,store:raw}; }
function addToBudget(mins){ const {today,store}=readBudget(); store[today].minutes += mins; localStorage.setItem(BUDGET_KEY, JSON.stringify(store)); }
function getBudget(){ const {today,store}=readBudget(); return store[today].minutes|0; }

/* ----------------------- DOM refs ----------------------- */
const $=s=>document.querySelector(s);
const presetSel=$('#presetSel'), presetTags=$('#presetTags');
const pulseHz=$('#pulseHz'), pulseHzV=$('#pulseHzV');
const carrierHz=$('#carrierHz'), carrierHzV=$('#carrierHzV');
const depth=$('#depth'), depthV=$('#depthV');
const waveGain=$('#waveGain'), waveGainV=$('#waveGainV');
const startWaveBtn=$('#startWave'), stopWaveBtn=$('#stopWave'), statusEl=$('#status');
const lenSel=$('#length'), timerEl=$('#timer');
const histEl=$('#hist'), clearHist=$('#clearHist');
const enableMicBtn=$('#enableMic'), micState=$('#micState'), snapState=$('#snapState'), wakeState=$('#wakeState');
const riskBadge=$('#riskBadge'), budgetBadge=$('#budgetBadge'), safetyNotes=$('#safetyNotes');
const panicCalm=$('#panicCalm'), autoNormalize=$('#autoNormalize');
const chips=[...document.querySelectorAll('[data-chip]')];

/* --------- FIX: declare currentSafety BEFORE any use --------- */
let currentSafety = {risk:'low', maxMinutes:30, minBreakMin:10, maxDepth:0.8, maxWaveGain:0.35, notes:[]};
/* ------------------------------------------------------------- */

/* ------------- UI: build preset list + filters ------------ */
function renderPresets(filter='all'){
  presetSel.innerHTML='';
  const list = PRESETS.playlists.filter(p=> filter==='all' ? true : p.cat===filter);
  for(const p of list){
    const opt=document.createElement('option');
    opt.value=p.id; opt.textContent=`${p.label} (${p.pulseHz} Hz)`;
    opt.dataset.cat=p.cat;
    presetSel.appendChild(opt);
  }
  if(list.length){ applyPreset(list[0].id); }
}
chips.forEach(ch=>{
  ch.addEventListener('click', ()=>{
    chips.forEach(c=>c.dataset.active='0'); ch.dataset.active='1';
    renderPresets(ch.dataset.cat);
  });
});
renderPresets('all');

/* ----------------- Audio engine state ----------------- */

function safetySummaryToUI(s){
  riskBadge.textContent = `Risk: ${s.risk}`;
  riskBadge.style.background = s.risk==='high' ? '#fee2e2' : (s.risk==='medium' ? '#ffedd5' : '#e2fbe8');
  riskBadge.style.color = '#111827';
  const daily = getBudget();
  const budgetCap = 60;
  const okay = daily < budgetCap;
  budgetBadge.textContent = `Stim budget: ${okay ? 'OK' : 'Exceeded'} (${daily}/${budgetCap} min)`;
  budgetBadge.style.background = okay ? '#e2fbe8' : '#fee2e2';
  safetyNotes.innerHTML = [
    `<li>Max session: <strong>${s.maxMinutes} min</strong> • Min break: <strong>${s.minBreakMin} min</strong></li>`,
    `<li>Depth cap: <strong>${s.maxDepth.toFixed(2)}</strong> • Wave cap: <strong>${s.maxWaveGain.toFixed(2)}</strong></li>`,
    ...(s.notes||[]).map(n=>`<li>${n}</li>`),
    `<li>Keep device volume moderate. Stop on discomfort.</li>`
  ].join('');
}

var ctx = null, bus = null, gainOut = null, carrierOsc = null, lfoOsc = null, env = null;
var running = false, timerId = null, startTs = 0, sessionLenMin = 0;

/* Apply preset and guardrails */
function applyPreset(id){
  const p = PRESETS.playlists.find(x=>x.id===id) || PRESETS.playlists[0];
  const s = computeSafety(p.pulseHz, p.cat);
  currentSafety = s;                           /* safe to assign now */

  pulseHz.value   = p.pulseHz;  pulseHzV.textContent = Number(p.pulseHz).toFixed(1);
  carrierHz.value = p.carrierHz; carrierHzV.textContent = String(p.carrierHz|0);
  depth.value     = Math.min(PRESETS.isochronic.depth, s.maxDepth);
  depthV.textContent = Number(depth.value).toFixed(2);
  waveGain.value  = Math.min(p.waveGain, s.maxWaveGain);
  waveGainV.textContent = Number(waveGain.value).toFixed(2);

  presetTags.innerHTML = `<span class="badge">Category: ${p.cat}</span>`;
  safetySummaryToUI(s);

  if (ctx && running) rebuildIso();
}
presetSel.addEventListener('change', ()=>applyPreset(presetSel.value));

/* Live mirrors with caps */
[pulseHz, carrierHz, depth, waveGain].forEach(el=>{
  el.addEventListener('input', ()=>{
    // Guard against early calls before currentSafety exists
    const s = currentSafety || {maxDepth:0.9,maxWaveGain:0.45};
    if(el===depth && +depth.value > s.maxDepth) depth.value = s.maxDepth;
    if(el===waveGain && +waveGain.value > s.maxWaveGain) waveGain.value = s.maxWaveGain;

    if(el===pulseHz)   pulseHzV.textContent=Number(el.value).toFixed(1);
    if(el===carrierHz) carrierHzV.textContent=String(el.value|0);
    if(el===depth)     depthV.textContent=Number(el.value).toFixed(2);
    if(el===waveGain)  waveGainV.textContent=Number(el.value).toFixed(2);
    if(ctx && running){
      if(el!==waveGain) rebuildIso();
      else if(gainOut)  gainOut.gain.value=+waveGain.value;
    }
  });
});

/* ----------------- WebAudio core ----------------- */
function ensureCtx(){
  if(ctx) return;
  ctx = new (window.AudioContext||window.webkitAudioContext)();
  bus = ctx.createGain();
  gainOut = ctx.createGain(); gainOut.gain.value=+waveGain.value;
  const comp=ctx.createDynamicsCompressor();
  comp.threshold.value=-12; comp.knee.value=18; comp.ratio.value=3; comp.attack.value=0.005; comp.release.value=0.06;
  bus.connect(comp).connect(gainOut).connect(ctx.destination);
}

function rebuildIso(){
  if(!ctx) return;
  stopIso(false);

  carrierOsc=ctx.createOscillator(); carrierOsc.type='sine'; carrierOsc.frequency.value=+carrierHz.value;

  const lfoOsc=ctx.createOscillator(); lfoOsc.type='sine';
  const rectGain=ctx.createGain(); rectGain.gain.value=0.5;
  const plusHalf=ctx.createConstantSource(); plusHalf.offset.value=0.5;

  const depthGain=ctx.createGain(); depthGain.gain.value=+depth.value;
  const base=ctx.createConstantSource(); base.offset.value=1 - (+depth.value);

  const rectSum=ctx.createGain();
  const envSum=ctx.createGain();
  env=ctx.createGain(); env.gain.value=0;

  lfoOsc.connect(rectGain).connect(rectSum);
  plusHalf.connect(rectSum);
  rectSum.connect(depthGain).connect(envSum);
  base.connect(envSum);
  envSum.connect(env.gain);

  carrierOsc.connect(env).connect(bus);

  const now=ctx.currentTime;
  lfoOsc.frequency.setValueAtTime(+pulseHz.value, now);
  lfoOsc.start(now); plusHalf.start(now); base.start(now); carrierOsc.start(now);

  const a=PRESETS.isochronic.attackMs/1000;
  env.gain.setTargetAtTime(env.gain.value, now, 0.001);
  env.gain.setTargetAtTime(1.0, now, a);

  gainOut.gain.setValueAtTime(+waveGain.value, now);
  running=true;
  statusEl.textContent=`Pulse ${(+pulseHz.value).toFixed(1)} Hz • Carrier ${(+carrierHz.value|0)} Hz`;
}

function stopIso(hard=true){
  if(!ctx || !running) return;
  const now=ctx.currentTime, r=PRESETS.isochronic.releaseMs/1000;
  try{
    if(hard){ carrierOsc.stop(); /* lfo + sources stop via GC after disconnect */ }
    else{
      env.gain.setTargetAtTime(env.gain.value, now, 0.001);
      env.gain.setTargetAtTime(0, now, r);
      setTimeout(()=>{ try{carrierOsc.stop();}catch{} }, PRESETS.isochronic.releaseMs+40);
    }
  }catch{}
  try{carrierOsc.disconnect(); env.disconnect();}catch{}
  running=false; statusEl.textContent='Idle';
}

/* Beeps */
function playNotify(kind){
  ensureCtx();
  if(ctx.state==='suspended'){ ctx.resume().catch(()=>{}); }
  const now=ctx.currentTime;
  function beep(freq, tOffset, dur=0.12, gain=0.12){
    const o=ctx.createOscillator(); const g=ctx.createGain();
    o.type='sine'; o.frequency.setValueAtTime(freq, now+tOffset);
    g.gain.setValueAtTime(0, now+tOffset);
    g.gain.linearRampToValueAtTime(gain, now+tOffset+0.02);
    g.gain.linearRampToValueAtTime(0,    now+tOffset+dur);
    o.connect(g).connect(ctx.destination);
    o.start(now+tOffset); o.stop(now+tOffset+dur+0.02);
  }
  if(kind==='start'){ beep(880,0.00); beep(1320,0.14); }
  else{ beep(660,0.00); beep(440,0.14); }
}

/* Timer + session */
function tick(){
  if(!startTs){ timerEl.textContent='00:00'; return; }
  const elapsed=Math.floor((Date.now()-startTs)/1000);
  const mm=String(Math.floor(elapsed/60)).padStart(2,'0');
  const ss=String(elapsed%60).padStart(2,'0');
  timerEl.textContent=`${mm}:${ss}`;
  if(sessionLenMin>0 && elapsed>=sessionLenMin*60){ stopSession(true); }
}

function startSession(){
  const p = PRESETS.playlists.find(x=>x.id===presetSel.value);
  const s = computeSafety(+pulseHz.value, p.cat);
  currentSafety=s; safetySummaryToUI(s);

  depth.value = Math.min(+depth.value, s.maxDepth); depthV.textContent=Number(depth.value).toFixed(2);
  waveGain.value = Math.min(+waveGain.value, s.maxWaveGain); waveGainV.textContent=Number(waveGain.value).toFixed(2);

  const activating = +pulseHz.value >= 14;
  const minutesReq = parseInt(lenSel.value,10) || 30;
  const used = getBudget();
  const dailyCap = 60;
  if(activating){
    if(minutesReq > s.maxMinutes){ lenSel.value = String(s.maxMinutes); }
    if(used >= dailyCap){
      alertSafe('Daily stimulating budget exceeded. Try a calm preset or come back tomorrow.');
      return;
    }
  }

  ensureCtx(); if(ctx.state==='suspended'){ ctx.resume().catch(()=>{}); }
  rebuildIso();
  sessionLenMin = Math.min(parseInt(lenSel.value,10) || 30, s.maxMinutes);
  startTs=Date.now();
  if(timerId) clearInterval(timerId);
  timerId=setInterval(tick,1000); tick();
  pushHist();
  requestWake();
  playNotify('start');
}

function stopSession(completed=false){
  playNotify('stop');
  stopIso(false);
  if(timerId){ clearInterval(timerId); timerId=null; }
  const elapsedMin = startTs ? Math.round((Date.now()-startTs)/60000) : 0;
  if(startTs){
    const pulse = +pulseHz.value;
    if(pulse>=14 && elapsedMin>0){ addToBudget(elapsedMin); }
  }
  startTs=0; tick();
  releaseWake();

  if(completed && autoNormalize.checked){
    applyPreset('normalize_soft');
    lenSel.value = '2';
    startSession();
  }
}

function alertSafe(msg){
  const warn = document.createElement('div');
  warn.className='mt-2 text-[12px] text-red-700 bg-red-50 border border-red-200 rounded p-2';
  warn.textContent = msg;
  safetyNotes.parentElement.appendChild(warn);
  setTimeout(()=>warn.remove(), 6000);
}

startWaveBtn.addEventListener('click', startSession);
stopWaveBtn.addEventListener('click', ()=>stopSession(false));
panicCalm.addEventListener('click', ()=>{
  applyPreset('normalize_soft');
  lenSel.value='2';
  startSession();
});

/* ---------------- History ---------------- */
const HIST_KEY='vibe_hist_pure_v1';
function renderHist(){
  const rows=(JSON.parse(localStorage.getItem(HIST_KEY)||'[]')||[]).slice(-8).reverse();
  histEl.innerHTML = rows.length ? rows.map(r=>`<div class="flex items-center justify-between">
    <span class="text-slate-600">${new Date(r.ts).toLocaleString()}</span>
    <span class="value">${r.label} • ${r.pulse}Hz • ${r.mins}m</span>
  </div>`).join('') : `<div class="text-slate-500">No sessions yet.</div>`;
}
function pushHist(){
  const id=presetSel.value; const p=PRESETS.playlists.find(x=>x.id===id)||{label:id};
  const rows=JSON.parse(localStorage.getItem(HIST_KEY)||'[]')||[];
  const mins = parseInt(lenSel.value,10) || 30;
  rows.push({ts:Date.now(),label:p.label,pulse:+pulseHz.value,mins});
  localStorage.setItem(HIST_KEY, JSON.stringify(rows)); renderHist();
}
clearHist.addEventListener('click', ()=>{ localStorage.removeItem(HIST_KEY); renderHist(); });
renderHist();

/* ------------- Snap start/stop (graceful) ------------- */
const snapStateEl = snapState;
let micCtx=null, micStream=null, micSource=null, hp=null, bp=null, micAnalyser=null, micBuf=null, micRAF=null;
let envLevel=0, noiseFloor=0.01, lastSnapAt=0;
const MIN_GAP_MS=260;

function toggleSession(){ running ? stopSession(false) : startSession(); }

enableMicBtn.addEventListener('click', async ()=>{
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    micState.textContent='Mic: unsupported';
    return;
  }
  try{
    micStream = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true,autoGainControl:false}});
    micCtx = new (window.AudioContext||window.webkitAudioContext)();
    micSource = micCtx.createMediaStreamSource(micStream);
    hp = micCtx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1200;
    bp = micCtx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=3000; bp.Q.value=1.2;
    micAnalyser = micCtx.createAnalyser(); micAnalyser.fftSize=1024; micAnalyser.smoothingTimeConstant=0.02;
    micSource.connect(hp).connect(bp).connect(micAnalyser);
    micBuf = new Float32Array(micAnalyser.fftSize);
    micState.textContent='Mic: on';
    enableMicBtn.disabled=true;
    listenLoop();
  }catch(e){
    micState.textContent='Mic: denied';
  }
});

function listenLoop(){
  if(!micAnalyser){ return; }
  micAnalyser.getFloatTimeDomainData(micBuf);
  let sum=0; for(let i=0;i<micBuf.length;i++){ const v=micBuf[i]; sum+=v*v; }
  const rms=Math.sqrt(sum/micBuf.length);
  envLevel = 0.9*envLevel + 0.1*rms;
  const baseline = Math.max(0.008, 0.98*noiseFloor + 0.02*envLevel);
  noiseFloor = baseline;
  const now=performance.now();
  const threshold=Math.max(0.08, baseline*3.5);
  const hit = rms > threshold && (now - lastSnapAt) > MIN_GAP_MS;

  if(hit){
    lastSnapAt = now;
    snapStateEl.textContent='Snaps: toggle';
    toggleSession();
  }else if(!running){
    snapStateEl.textContent='Snaps: listening';
  }
  micRAF = requestAnimationFrame(listenLoop);
}

/* ---------------- Keep Awake (graceful) ---------------- */
let wakeLock=null;
async function requestWake(){
  try{
    if('wakeLock' in navigator){
      wakeLock = await navigator.wakeLock.request('screen');
      wakeState.textContent='Awake: on';
      wakeLock.addEventListener('release', ()=>{ wakeState.textContent='Awake: off'; if(running) requestWake().catch(()=>{}); });
    }else{
      wakeState.textContent='Awake: n/a';
    }
  }catch{}
}
async function releaseWake(){
  try{ if(wakeLock){ await wakeLock.release(); wakeLock=null; wakeState.textContent='Awake: off'; } }catch{}
}
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState==='visible' && running) requestWake().catch(()=>{});
});
</script>
</body>
</html>